# Joplin 插件 - 外部编辑器按钮功能需求分析

## 一、需求背景

### 1.1 现状分析

Joplin 原生提供了一个"切换外部编辑器"功能，允许用户在外部编辑器（如 Typora、VS Code 等）中编辑当前笔记。该功能在工具栏中有一个切换按钮，点击后会在外部编辑器中打开当前笔记。

但是，原生的外部编辑器功能存在以下限制：

1. **无法干预导出过程**：导出格式固定，无法自定义导出逻辑
2. **无法干预导入过程**：导入回 Joplin 时无法处理特殊的资源链接或元数据
3. **无法添加中间处理步骤**：无法在导出和导入之间执行自定义操作

### 1.2 核心需求

用户希望在 Joplin 编辑器工具栏添加一个自定义按钮，实现以下功能：

1. **导出当前笔记**：将当前正在编辑的笔记导出为 Markdown 文件
2. **打开外部编辑器**：在外部编辑器（如 Typora）中打开导出的文件
3. **监控文件变化**：监听外部编辑器的保存操作
4. **导入回 Joplin**：将外部编辑器修改后的内容导入回 Joplin
5. **自定义处理**：在导出和导入过程中可以插入自定义逻辑

### 1.3 与现有功能的关系

本插件已经实现了：
- **导出模块**：通过 `joplin.interop.registerExportModule()` 注册的导出功能
- **导入模块**：通过 `joplin.interop.registerImportModule()` 注册的导入功能

新的外部编辑器按钮将复用这些导出和导入逻辑，但提供更流畅的编辑体验。

## 二、需求分析

### 2.1 功能需求

#### FR1: 工具栏按钮

在 Joplin 编辑器工具栏添加一个"切换外部编辑"按钮。

**优先级**：高

**描述**：
- 按钮位置：编辑器工具栏
- 按钮文本："切换外部编辑"
- 按钮图标：`fas fa-book-open`
- 按钮状态：只有在选中笔记时可用

#### FR2: 导出当前笔记

点击按钮后，导出当前选中的笔记到临时目录。

**优先级**：高

**描述**：
- 获取当前选中的笔记
- 使用现有的导出逻辑导出笔记
- 导出路径：临时目录，使用 `joplin.plugins.dataDir()` 或用户配置的临时目录
- 文件名：使用哈希文件名格式 `edit-{noteId}.md`（便于精确匹配）
- 包含资源：同时导出笔记中的所有资源文件
- 导出前检测：如果目标文件已存在，先删除再写入

#### FR3: 打开外部编辑器

导出完成后，自动在外部编辑器中打开导出的文件。

**优先级**：高

**描述**：
- 支持配置外部编辑器路径（如 Typora、code、obsidian）
- 自动打开导出的 Markdown 文件
- Windows/macOS 可以使用应用名称，Linux 需要完整路径
- 返回编辑器 PID 用于后续管理

**实现细节**：
- **Windows 平台**：使用两步法
  1. 使用 `cmd /c start` 启动编辑器
  2. 延时 2 秒后，使用 `wmic` 命令通过文件路径查询编辑器真实 PID
  3. 自动补全 `.exe` 后缀（如果进程名没有以 `.exe` 结尾）
- **macOS 平台**：使用 `open -a` 命令启动，返回子进程 PID
- **Linux 平台**：使用 `spawn` 直接启动，返回子进程 PID

#### FR4: 监控文件变化

监听外部编辑器对文件的修改。

**优先级**：中

**描述**：
- 监听导出的 Markdown 文件的变化
- 使用 `fs.watch()` 监控文件系统事件
- 检测到文件修改时触发同步逻辑
- 提供自动同步和手动同步两种模式

#### FR5: 导入回 Joplin

将外部编辑器修改后的内容同步回 Joplin。

**优先级**：高

**描述**：
- 使用 `updateNoteFromMarkdown()` 函数更新现有笔记
- 导入新的图片资源到 Joplin 资源库
- 替换图片引用为 Joplin 内部格式
- 更新笔记正文内容
- 保留 Joplin 的元数据（如标签、笔记本等）
- 同步成功时只输出日志，不弹出消息窗口

#### FR6: 配置选项

提供插件配置选项，让用户自定义行为。

**优先级**：中

**描述**：
- 外部编辑器路径配置
- 临时目录配置
- 自动同步开关（默认：true）
- 同步间隔配置（默认：5000 毫秒）

#### FR7: 按钮状态切换

工具栏按钮支持二元状态切换，提供更好的用户体验。

**优先级**：高

**描述**：
- **状态 1（idle/未按下）**：按钮处于正常状态
  - 点击后：导出当前笔记、打开外部编辑器、启动文件监控
  - 切换到状态 2

- **状态 2（editing/已按下）**：按钮处于编辑中状态
  - 点击后：停止文件监控、关闭外部编辑器、清理临时文件
  - 切换回状态 1

**技术实现**：
- 在 `EditingSession` 接口中添加 `buttonState` 字段（'idle' | 'editing'）
- 在 `EditingSession` 接口中添加 `editorPid` 字段（全平台统一）
- 实现 `closeEditorAndCleanup()` 函数，使用命令行关闭编辑器

**进程管理**：
- **Windows**：使用 `taskkill /F /PID {pid}` 命令强制终止
- **macOS/Linux**：使用 `kill -TERM {pid}` 和 `kill -KILL {pid}` 命令
- 不依赖进程句柄，统一使用 PID 和命令行操作

### 2.2 非功能需求

#### NFR1: 性能

- 导出操作应在 2 秒内完成（普通笔记）
- 导入操作应在 3 秒内完成（普通笔记）
- Windows 平台查询 PID 需要 2 秒延时

#### NFR2: 可靠性

- 确保数据不丢失
- 处理编辑器崩溃等异常情况
- 同步失败或异常时弹出消息窗口提示用户
- 导出前删除已存在文件，避免文件冲突

#### NFR3: 易用性

- 一键操作，无需复杂配置
- 同步成功时仅输出日志，不打扰用户
- 错误信息友好易懂

#### NFR4: 兼容性

- 支持 Windows、macOS、Linux
- 支持多种外部编辑器（Typora、VS Code、Obsidian 等）
- Windows 平台支持通过 wmic 精确匹配编辑器进程

## 三、技术实现思路

### 3.1 架构设计

```
用户点击"切换外部编辑"按钮
    ↓
检查按钮状态
    ↓
状态 1（idle）:
    1. 获取当前笔记信息
    2. 导出笔记到临时目录（复用 exporter.ts）
    3. 启动外部编辑器并获取 PID
    4. 启动文件监控
    5. 切换到状态 2
    ↓
状态 2（editing）:
    1. 停止文件监控
    2. 使用命令行关闭编辑器进程
    3. 清理临时文件
    4. 切换回状态 1
```

### 3.2 核心组件

#### 组件 1: 工具栏按钮管理器 (ToolbarButtonManager)

**职责**：
- 注册工具栏按钮
- 处理按钮点击事件
- 管理按钮状态和编辑会话

**使用 API**：
- `joplin.views.toolbarButtons.create()`
- `joplin.commands.register()`

**代码位置**：`src/toolbarButton.ts`

#### 组件 2: 外部编辑器管理器 (ExternalEditorManager)

**职责**：
- 启动外部编辑器
- 跨平台获取编辑器 PID
- 处理编辑器进程管理

**使用 API**：
- Node.js `child_process.spawn()`（启动）
- Node.js `child_process.exec()`（查询 PID）
- Windows `wmic` 命令（查询进程）

**代码位置**：`src/externalEditor.ts`

#### 组件 3: 同步管理器 (SyncManager)

**职责**：
- 监听文件变化
- 触发同步操作
- 管理编辑会话

**使用 API**：
- Node.js `fs.watch()`
- `joplin.workspace.selectedNote()`
- `joplin.data.put()`

**代码位置**：`src/syncManager.ts`

#### 组件 4: 导入管理器 (Importer)

**职责**：
- 导入 Markdown 内容
- 导入图片资源
- 更新现有笔记

**代码位置**：`src/importer.ts`

### 3.3 关键技术点

#### 3.3.1 工具栏按钮注册

```typescript
// 注册命令
await joplin.commands.register({
  name: 'openInExternalEditor',
  label: '切换外部编辑',
  iconName: 'fas fa-book-open',
  execute: async () => {
    await handleOpenInExternalEditor();
  },
});

// 创建工具栏按钮
await joplin.views.toolbarButtons.create(
  "openInExternalEditorButton",
  "openInExternalEditor",
  ToolbarButtonLocation.NoteToolbar
);
```

#### 3.3.2 按钮状态切换

```typescript
const handleOpenInExternalEditor = async (): Promise<void> => {
  const session = editingSessions.get(noteId);
  
  if (session && session.buttonState === 'editing') {
    // 状态 2 -> 状态 1：关闭编辑器
    await closeEditorAndCleanup(noteId);
  } else {
    // 状态 1 -> 状态 2：打开编辑器
    await openEditorAndSync(noteId);
  }
};
```

#### 3.3.3 Windows 平台编辑器 PID 查询

```typescript
// 步骤 1：启动编辑器
const cmdProcess = spawn('cmd.exe', ['/c', 'start', '""', '/b', `"${editorPath}"`, `"${filePath}"`]);

// 步骤 2：延时等待编辑器启动
await sleep(2000);

// 步骤 3：使用 wmic 查询编辑器 PID
const editorProcessName = path.basename(editorPath);
if (!editorProcessName.toLowerCase().endsWith('.exe')) {
  editorProcessName += '.exe';
}

const wmicCmd = `wmic process where "Name='${editorProcessName}' and CommandLine like '%${escapedFilePath}%'" get ProcessId /format:list`;
const editorPid = await queryEditorPid(editorProcessName, filePath);
```

#### 3.3.4 进程关闭（全平台统一）

```typescript
// Windows
exec(`taskkill /F /PID ${session.editorPid}`);

// macOS/Linux
exec(`kill -TERM ${session.editorPid}`);
setTimeout(() => exec(`kill -KILL ${session.editorPid}`), 1000);
```

#### 3.3.5 文件监控

```typescript
const watcher = fs.watch(session.tempFilePath, { persistent: false }, (eventType) => {
  if (eventType === "change") {
    if (this.config.autoSync) {
      this.scheduleAutoSync(session);
    } else {
      this.notifyFileChanged(session);
    }
  }
});
```

#### 3.3.6 更新现有笔记

```typescript
export const updateNoteFromMarkdown = async (
  markdownContent: string,
  sourceFilePath: string | null,
  noteId: string
): Promise<ImportResult> => {
  // 1. 导入新的图片资源
  // 2. 替换图片引用为 Joplin 内部格式
  // 3. 更新笔记内容
  await joplin.data.put(["notes", noteId], null, {
    author: newAuthor,
    body: processedContent,
  });
}
```

### 3.4 数据流

```
状态 1（idle）点击按钮
    ↓
[ToolbarButton] 检查状态 → 发现为 idle
    ↓
[Exporter] 导出笔记到临时目录（删除已存在文件）
    ↓
[ExternalEditor] 启动编辑器并获取 PID
    ↓
[SyncManager] 启动文件监控
    ↓
用户编辑并保存
    ↓
[SyncManager] 检测到文件变化
    ↓
[Importer] 更新现有笔记内容
    ↓
状态切换为 editing

状态 2（editing）点击按钮
    ↓
[ToolbarButton] 检查状态 → 发现为 editing
    ↓
[SyncManager] 停止文件监控
    ↓
[命令行] 关闭编辑器进程
    ↓
清理临时文件
    ↓
状态切换为 idle
```

### 3.5 状态管理

```typescript
interface EditingSession {
  noteId: string;           // Joplin 笔记 ID
  noteTitle: string;        // 笔记标题
  tempDir: string;          // 临时目录路径
  tempFilePath: string;     // 临时文件路径
  timestamp: number;        // 创建时间戳
  buttonState: 'idle' | 'editing'; // 按钮状态
  editorPid?: number;       // 编辑器 PID（全平台统一）
  fileWatcher?: fs.FSWatcher;   // 文件监控器
  syncTimeout?: NodeJS.Timeout;  // 同步超时定时器
}
```

### 3.6 错误处理

#### 错误场景 1: 获取当前笔记失败

**处理方式**：
- 显示错误提示："请先选择要编辑的笔记"
- 不改变按钮状态

#### 错误场景 2: 导出失败

**处理方式**：
- 显示错误提示："在外部编辑器中打开笔记失败"
- 清理临时文件
- 记录详细日志

#### 错误场景 3: 启动外部编辑器失败

**处理方式**：
- 显示错误提示："无法启动外部编辑器: {editorPath}"
- 提示用户检查编辑器路径设置

#### 错误场景 4: 导入失败

**处理方式**：
- 同步成功时：仅输出日志
- 同步失败或异常：弹出消息窗口提示用户
- 保留临时文件供手动恢复
- 记录详细日志

### 3.7 设置项

```typescript
export const SETTINGS_KEYS = {
  EXTERNAL_EDITOR_PATH: "externalEditorPath",
  TEMP_DIR_PATH: "tempDirPath",
  AUTO_SYNC: "autoSync",
  SYNC_INTERVAL: "syncInterval",
} as const;

const settingsConfig = {
  [SETTINGS_KEYS.EXTERNAL_EDITOR_PATH]: {
    type: SettingItemType.String,
    value: "Typora",
    label: "外部编辑器",
    description: "指定用于打开笔记的外部编辑器（如 Typora、code、obsidian）",
  },
  [SETTINGS_KEYS.TEMP_DIR_PATH]: {
    type: SettingItemType.String,
    value: "",
    label: "临时目录",
    description: "指定临时导出文件的目录，留空则使用插件数据目录",
  },
  [SETTINGS_KEYS.AUTO_SYNC]: {
    type: SettingItemType.Bool,
    value: true,
    label: "自动同步",
    description: "检测到文件修改时自动同步回 Joplin",
  },
  [SETTINGS_KEYS.SYNC_INTERVAL]: {
    type: SettingItemType.Int,
    value: 5000,
    label: "同步间隔（毫秒）",
    description: "文件变化后等待的时间，用于防抖",
  },
};
```

## 四、实现步骤

### 阶段 1: 基础框架

1. 创建 `src/toolbarButton.ts` - 工具栏按钮注册和状态管理
2. 创建 `src/externalEditor.ts` - 外部编辑器启动和 PID 查询
3. 在 `src/index.ts` 中集成新组件
4. 添加相关设置项

### 阶段 2: 导出功能

1. 在 `src/exporter.ts` 中添加 `exportNoteToPath()` 函数
2. 实现单个笔记导出到指定路径
3. 添加导出前删除已存在文件的逻辑
4. 测试导出功能

### 阶段 3: 编辑器集成

1. 实现外部编辑器启动逻辑（跨平台）
2. 实现 Windows 平台 wmic 查询 PID
3. 实现 macOS/Linux 平台获取 PID
4. 测试编辑器启动

### 阶段 4: 导入功能

1. 在 `src/importer.ts` 中添加 `updateNoteFromMarkdown()` 函数
2. 实现更新现有笔记的逻辑
3. 测试导入功能

### 阶段 5: 文件监控

1. 创建 `src/syncManager.ts`
2. 实现文件变化监控（使用 fs.watch）
3. 实现自动同步逻辑
4. 添加防抖机制
5. 实现同步成功时不弹出窗口

### 阶段 6: 优化和完善

1. 实现按钮状态切换
2. 实现命令行关闭进程
3. 完善错误处理
4. 添加日志记录

## 五、注意事项

### 5.1 并发问题

- 用户可能同时打开多个笔记在外部编辑器中
- 需要维护多个编辑会话的状态
- 使用 Map 存储多个会话：`Map<string, EditingSession>`

### 5.2 资源清理

- 编辑完成后需要清理临时文件
- Joplin 关闭时需要清理所有临时文件
- 每次启动插件时清理遗留的临时文件

### 5.3 冲突处理

- 当用户在外部编辑器和 Joplin 中同时修改笔记时，当前实现会直接覆盖
- 未来可以添加合并或覆盖选项

### 5.4 平台兼容性

- **Windows**：使用 `wmic` 查询进程，`taskkill` 关闭进程
- **macOS**：使用 `open` 启动，`kill` 关闭进程
- **Linux**：使用 `spawn` 启动，`kill` 关闭进程
- 统一使用 PID 和命令行操作，不依赖进程句柄

### 5.5 进程管理

- Windows 平台使用 `wmic` 通过文件路径精确匹配编辑器进程
- 全平台统一使用命令行关闭进程，避免依赖进程句柄
- Windows 平台自动补全 `.exe` 后缀（如果进程名没有）

## 六、参考资源

### 6.1 Joplin API 文档

- [Joplin Views ToolbarButtons](https://joplinapp.org/api/references/plugin_api/classes/joplinviewstoolbarbuttons/)
- [Joplin Commands](https://joplinapp.org/api/references/plugin_api/classes/joplincommands/)
- [Joplin Workspace](https://joplinapp.org/api/references/plugin_api/classes/joplinworkspace/)

### 6.2 相关插件

- [YesYouKan Plugin](https://github.com/joplin/plugin-yesyoukan) - 编辑器插件示例
- [External Editor Plugin](https://github.com/joplin/plugin-external-editor) - 外部编辑器插件

### 6.3 技术文档

- [Node.js child_process](https://nodejs.org/api/child_process.html)
- [Node.js fs](https://nodejs.org/api/fs.html)
- [fs-extra](https://github.com/jprichardson/node-fs-extra) - 文件系统操作库

## 七、总结

通过添加工具栏按钮，用户可以一键将当前笔记导出到外部编辑器进行编辑，然后再导入回 Joplin。整个过程可以完全自定义，包括导出格式、资源处理、导入逻辑等。

这个功能的核心优势在于：
1. **无缝集成**：直接在 Joplin 工具栏中操作，无需手动导出导入
2. **完全控制**：可以干预导出和导入的每个环节
3. **灵活扩展**：可以添加自定义的预处理和后处理逻辑
4. **用户体验**：提供流畅的编辑体验，支持按钮状态切换
5. **跨平台支持**：Windows 使用 wmic 精确查询进程，全平台统一使用命令行管理

实现此功能需要以下新模块：
- `src/toolbarButton.ts` - 工具栏按钮管理
- `src/externalEditor.ts` - 外部编辑器管理
- `src/syncManager.ts` - 文件同步管理

需要修改的现有模块：
- `src/exporter.ts` - 添加单个笔记导出功能和文件存在检测
- `src/importer.ts` - 添加更新现有笔记功能
- `src/settings.ts` - 添加新的设置项
- `src/index.ts` - 集成新组件