# Joplin 数据库结构分析

## 概述

基于 Joplin API 的 TypeScript 类型定义分析，Joplin 使用一个关系型数据库来存储笔记、文件夹、标签、资源等数据。本文档总结了数据库实体及其之间的关系。

## 核心实体 (ModelType)

Joplin 定义了以下核心实体类型：

| 实体类型           | 数值 | 描述                 |
| ------------------ | ---- | -------------------- |
| Note               | 1    | 笔记                 |
| Folder             | 2    | 文件夹（笔记本）     |
| Setting            | 3    | 设置                 |
| Resource           | 4    | 资源（附件、图片等） |
| Tag                | 5    | 标签                 |
| NoteTag            | 6    | 笔记-标签关联表      |
| Search             | 7    | 搜索                 |
| Alarm              | 8    | 提醒/闹钟            |
| MasterKey          | 9    | 主密钥（用于加密）   |
| ItemChange         | 10   | 项目变更记录         |
| NoteResource       | 11   | 笔记-资源关联表      |
| ResourceLocalState | 12   | 资源本地状态         |
| Revision           | 13   | 版本                 |
| Migration          | 14   | 迁移                 |
| SmartFilter        | 15   | 智能筛选器           |
| Command            | 16   | 命令                 |

## 数据关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Joplin 数据库结构                          │
└─────────────────────────────────────────────────────────────────┘

    ┌──────────────┐
    │   Folder     │ (笔记本/文件夹)
    │   (parent)   │
    └──────┬───────┘
           │ 1
           │
           │ *
    ┌──────▼────────┐       ┌─────────────────┐
    │    Note       │◄──────│  ItemChange     │
    │  (笔记)       │  1    │  (变更记录)     │
    └──────┬────────┘       └─────────────────┘
           │
           │ *
    ┌──────▼─────────┐
    │  NoteResource  │
    │ (笔记-资源)    │
    └──────┬─────────┘
           │ *
    ┌──────▼────────┐       ┌─────────────────┐
    │   Resource    │◄──────│ResourceLocalState│
    │   (资源)      │  1    │  (资源本地状态)  │
    └───────────────┘       └─────────────────┘

    ┌──────┐       ┌──────┐
    │ Note │◄─────┤ Tag  │
    └──┬───┘  *   └──────┘
       │
       │ 1
    ┌──▼──────┐
    │ NoteTag │
    │(关联表)  │
    └─────────┘

    ┌───────┐
    │ Alarm │
    └───┬───┘
        │ 1
        │
    ┌───▼──────┐
    │  Note    │
    └──────────┘

    ┌──────────┐
    │  Search  │ (智能搜索)
    └──────────┘

    ┌──────────┐
    │ Setting  │ (应用设置)
    └──────────┘

    ┌──────────┐
    │MasterKey │ (加密密钥)
    └──────────┘

    ┌──────────┐
    │ Revision │ (版本历史)
    └──────────┘
```

## 详细实体关系

### 1. Folder (文件夹) - Note (笔记)

**关系类型**: 一对多 (1:N)

- 一个文件夹可以包含多个笔记
- 每个笔记属于一个文件夹（通过 `parent_id` 关联）
- 支持层级结构：文件夹可以嵌套（通过 `parent_id`）

**Note 实体字段**:

- `id`: 笔记ID
- `parent_id`: 所属文件夹ID
- `title`: 标题
- `body`: 内容 (Markdown)
- `created_time`, `updated_time`, `user_created_time`, `user_updated_time`: 时间戳
- `is_todo`: 是否为待办事项
- `todo_completed`: 待办完成时间
- `todo_due`: 待办截止时间
- `latitude`, `longitude`, `altitude`: 地理位置信息
- `author`: 作者
- `source`, `source_url`, `source_application`: 来源信息
- `markup_language`: 标记语言
- `is_shared`: 是否共享
- `share_id`: 共享ID
- `master_key_id`: 主密钥ID（加密）
- `encryption_applied`, `encryption_cipher_text`: 加密相关
- `is_conflict`, `conflict_original_id`: 冲突处理
- `application_data`: 应用数据
- `order`: 排序
- `user_data`: 用户数据
- `type_`: 类型

**Folder 实体字段**:

- `id`: 文件夹ID
- `parent_id`: 父文件夹ID
- `title`: 标题
- `created_time`, `updated_time`, `user_created_time`, `user_updated_time`: 时间戳
- `type_`: 类型
- `icon`: 图标
- `is_shared`: 是否共享
- `share_id`: 共享ID
- `master_key_id`: 主密钥ID
- `encryption_applied`, `encryption_cipher_text`: 加密相关
- `user_data`: 用户数据

### 2. Note (笔记) - Resource (资源)

**关系类型**: 多对多 (M:N)，通过 NoteResource 中间表

- 一个笔记可以关联多个资源
- 一个资源可以被多个笔记使用

**Resource 实体字段**:

- `id`: 资源ID
- `title`: 标题
- `mime`: MIME类型
- `filename`: 文件名
- `file_extension`: 文件扩展名
- `size`: 文件大小
- `created_time`, `updated_time`, `user_created_time`, `user_updated_time`: 时间戳
- `encryption_blob`: 加密数据块
- `encryption_applied`, `encryption_cipher_text`: 加密相关
- `master_key_id`: 主密钥ID
- `is_shared`: 是否共享
- `share_id`: 共享ID
- `user_data`: 用户数据

**NoteResource 关联表**:

- 连接 Note 和 Resource

### 3. Note (笔记) - Tag (标签)

**关系类型**: 多对多 (M:N)，通过 NoteTag 中间表

- 一个笔记可以有多个标签
- 一个标签可以关联多个笔记

**Tag 实体字段**:

- `id`: 标签ID
- `parent_id`: 父标签ID（支持标签层级）
- `title`: 标签名称
- `created_time`, `updated_time`, `user_created_time`, `user_updated_time`: 时间戳
- `type_`: 类型
- `encryption_applied`, `encryption_cipher_text`: 加密相关
- `is_shared`: 是否共享
- `share_id`: 共享ID
- `master_key_id`: 主密钥ID
- `user_data`: 用户数据

**NoteTag 关联表**:

- `note_id`: 笔记ID
- `tag_id`: 标签ID

### 4. Note (笔记) - Alarm (提醒)

**关系类型**: 一对一 (1:1) 或 一对多 (1:N)

- 笔记可以设置提醒（特别是待办事项笔记）
- 提醒与笔记关联

### 5. Note (笔记) - ItemChange (变更记录)

**关系类型**: 一对多 (1:N)

- 每个笔记的变更都会产生记录
- 用于同步和冲突检测

### 6. Resource (资源) - ResourceLocalState (资源本地状态)

**关系类型**: 一对一 (1:1)

- 记录资源的本地同步状态
- 用于多设备同步

### 7. 其他实体

**Setting**: 存储应用级和插件级设置
**Search**: 存储搜索查询和智能筛选器
**MasterKey**: 存储加密主密钥
**Revision**: 存储笔记的版本历史
**Command**: 存储注册的命令

## 数据访问 API

Joplin 通过 RESTful 风格的 API 访问数据：

```
GET    /notes          # 获取所有笔记
GET    /notes/:id      # 获取特定笔记
POST   /notes          # 创建笔记
PUT    /notes/:id      # 更新笔记
DELETE /notes/:id      # 删除笔记

GET    /folders        # 获取所有文件夹
GET    /folders/:id    # 获取特定文件夹
POST   /folders        # 创建文件夹
PUT    /folders/:id    # 更新文件夹
DELETE /folders/:id    # 删除文件夹

GET    /notes/:id/resources      # 获取笔记关联的资源
GET    /notes/:id/tags           # 获取笔记关联的标签
GET    /tags/:id/notes           # 获取标签关联的笔记
```

## 用户数据 (User Data)

Joplin 支持为每个实体存储键值对形式的用户数据：

- 通过 `userDataGet()` 获取
- 通过 `userDataSet()` 设置
- 通过 `userDataDelete()` 删除
- 支持跨设备同步（基于时间戳合并）

## 加密支持

多个实体支持端到端加密：

- 使用 `MasterKey` 管理加密密钥
- 加密字段：`encryption_applied`, `encryption_cipher_text`, `encryption_blob`
- `master_key_id` 关联到具体的加密密钥

## 同步机制

通过以下机制实现多设备同步：

- `ItemChange`: 记录所有变更
- `ResourceLocalState`: 资源同步状态
- 时间戳字段 (`created_time`, `updated_time`, `user_created_time`, `user_updated_time`)
- 用户数据的时间戳合并策略
